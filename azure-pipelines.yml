trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  nodeVersion: '18.x'

stages:
  - stage: CleanArtifacts
    displayName: 'Clean gh-pages branch'
    jobs:
    - job: CleanArtifactsFromGhPages
      displayName: 'Clean artifacts from gh-pages branch'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self
          clean: true
          persistCredentials: true

        - script: |
            git config --global user.name "azure-pipelines[bot]"
            git config --global user.email "azure-pipelines@dev.azure.com"

            git fetch origin

            # Verifica se a branch gh-pages existe
            if git ls-remote --exit-code --heads origin gh-pages; then
              echo "Branch gh-pages já existe. Fazendo checkout..."
              git checkout gh-pages
            else
              echo "Branch gh-pages não existe. Criando..."
              git checkout --orphan gh-pages
              git rm -rf .
              echo "Inicialização da gh-pages" > index.html
              git add index.html
              git commit -m "Init gh-pages"
              git push origin gh-pages
            fi

            # Limpa os arquivos da branch
            git rm -rf . || true
            git clean -fxd
            git commit --allow-empty -m "Complete cleanup of gh-pages"
            git push origin gh-pages
          displayName: 'Verifica/cria e limpa branch gh-pages'

  - stage: CI
    dependsOn: CleanArtifacts
    displayName: 'Run Cypress Tests'
    jobs:
      - job: CypressTests
        strategy:
          matrix:
            chrome:
              browser: chrome
            edge:
              browser: edge
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(HOME)/.npm

          - script: npm install
            displayName: 'Install dependencies'

          - script: npm run lint:fix
            displayName: 'Run ESLint'

          - script: |
              npx cypress run --browser $(browser) --spec "cypress/e2e/gui/authentication/loginGUI.cy.js,cypress/e2e/api/authentication/loginAPI.cy.js" --reporter mochawesome --reporter-options reportDir=cypress/reports/mochawesome,overwrite=false,html=false,json=true
            displayName: 'Run Cypress'
            continueOnError: true

          - script: npm run report:merge
            displayName: 'Merge test reports'

          - script: npm run report:generate
            displayName: 'Generate HTML report'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: 'cypress'
              artifactName: 'cypress-artifacts-$(browser)'
              publishLocation: 'Container'
              condition: always()

  - stage: CD
    dependsOn: CI
    displayName: 'Publish to GitHub Pages'
    jobs:
      - job: DeployAll
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            persistCredentials: true
            clean: true
            fetchDepth: 0

    # Baixa artefatos de AMBOS browsers (chrome e edge)
          - task: DownloadBuildArtifacts@0
            inputs:
              artifactName: 'cypress-artifacts-chrome'
              downloadPath: $(Build.SourcesDirectory)/artifacts/chrome
          - task: DownloadBuildArtifacts@0
            inputs:
              artifactName: 'cypress-artifacts-edge'
              downloadPath: $(Build.SourcesDirectory)/artifacts/edge

          # Organiza os arquivos de AMBOS browsers
          - script: |
              mkdir -p ./chrome/videos ./edge/videos
              mkdir -p ./chrome/screenshots ./edge/screenshots
              # Copia chrome
              cp -r ./artifacts/chrome/videos/* ./chrome/videos/
              cp -r ./artifacts/chrome/screenshots/* ./chrome/screenshots/
              cp -r ./artifacts/chrome/reports/mochawesome/* ./chrome/ || true
              # Copia edge
              cp -r ./artifacts/edge/videos/* ./edge/videos/
              cp -r ./artifacts/edge/screenshots/* ./edge/screenshots/
              cp -r ./artifacts/edge/reports/mochawesome/* ./edge/ || true
            displayName: 'Organize artifacts'

          # Gera o index.html (agora com dados de AMBOS browsers)
          - script: |
              mkdir -p ./public
              node generate-index.js
              cp -r ./public/index.html ./
            displayName: 'Generate Index'

          # Faz o deploy UMA ÚNICA VEZ (com chrome e edge juntos)
          - script: |
              git config user.name "azure-pipelines[bot]"
              git config user.email "azure-pipelines@bot.com"

              git fetch origin gh-pages || true
              git checkout --orphan gh-pages
              git reset --hard

              git add -f index.html ./chrome/ ./edge/
              git commit -m "Deploy Cypress reports for ALL browsers"
              git push origin gh-pages
            displayName: 'Deploy to gh-pages'